# Proves de penetraci√≥ (Pentesting)

---

## Penetration testing: Introducci√≥

> Prova de penetraci√≥

---

## Qu√® √©s _penetration testing_?

- Les **proves de penetraci√≥** avaluen la seguretat intentant activament **trobar vulnerabilitats explotables**
  - Activitat de _**black hat**_ (amb un bon prop√≤sit). Els practicants tamb√© s'anomenen _**red teams**_, _**tiger teams**_, etc.
- Es pot aplicar a diferents nivells de granularitat
  - **programa** (proc√©s √∫nic)
  - **sol¬∑licitud completa** (processos de comunicaci√≥)
  - **xarxa** de moltes aplicacions
  - generalment no a biblioteques ni fragments de codi incomplets

---

## Qui, i com

- Els _**pen testers**_ utilitzen **enginy** i **eines** **automatitzades**
  - Per explorar r√†pidament la superf√≠cie d'atac d'un sistema, cercant les debilitats per explotar
- Normalment **duit a terme per un grup separat** dins o fora d'una organitzaci√≥, independent dels desenvolupadors
  - **Evita la visi√≥ de t√∫nel**: la mateixa ra√≥ per la qual els metges solen no tractar-se a ells mateixos ni a les seves pr√≤pies fam√≠lies
- Podem simular **acc√©s variat a les parts internes del sistema**
  - Des de **no tenir acc√©s**, com un atacant extern, fins a l'**acc√©s total**, com una persona interna amb coneixements

---

![Bug bounty](./img/bug-bounty.png)

---

## Beneficis

- Les **penetracions** s√≥n **certes** i **reprodu√Øbles**, demostrades per proves
  - **No √©s hipot√®tic**
  - **Aplicat** a **tot un component**
    - no a fragments de codi
  - **Sense falses alarmes** (com l'an√†lisi est√†tic)
- Factor ‚Äúsentir-se b√©‚Äù.
  - Produeix **evid√®ncies de vulnerabilitats reals** que, d'altra manera, no s'haurien solucionat
  - D'aquesta manera es tradueix en una **clara millora de la seguretat**

---

## Inconvenients

- L'**abs√®ncia** de **penetracions** **no √©s una prova de seguretat**
  - Despr√©s d'arreglar qualsevol problema, pot haver-hi altres encara a l'aguait
- Els canvis al sistema requereixen una nova prova
  - La seguretat no √©s compositiva: un canvi a un component pot fer que un altre component sigui insegur
    - Per tant, cal tornar a provar tot el sistema
  - Per√≤ els canvis s√≥n habituals!
    - Pot ser car tornar a provar amb massa freq√º√®ncia
- No obstant aix√≤, **val la pena fer proves de penetraci√≥**

---

## Pen Testing

> Prova de penetraci√≥

---

## Qu√® √©s _pen testing_?

> "Science is what we understand well enough to explain to a computer. Art is everything else we do." - Donald Knuth

- _Pen testing_ √©s tant art com ci√®ncia
  - Els humans proven i interactuen amb un sistema, cercant diferents debilitats o vectors d'atac
    - Utilitzant l'intel¬∑lig√®ncia, l'adaptaci√≥ i l'enginy
- Un cop sorgeixen els patrons d'exploraci√≥ i explotaci√≥, es poden fer programes inform√†tics (eines) per fer el treball
  - Enginy/creativitat automatitzat

---

## Caixa d'eines del _pen tester_

- **Un _pen tester_ s'acosta a un objectiu sabent...**
  - el **funcionament** del domini objectiu (p. ex., el web)
  - .. com **est√† constru√Øt** el sistema en aquest domini
    - **Protocols** (p. ex., HTTP, TCP, ...)
    - **Llenguatges** (p. ex., PHP, Java, Ruby, ...)
    - **Frameworks** (p. ex., Rails, Dream Weaver, Drupal)
  - ... **debilitats comunes** en el programari/sistema
    - **Errors** (p. ex., injeccions SQL, XSS, CSRF, ...)
    - **Configuracions incorrectes, mal disseny** (p. ex., contrasenyes predeterminades, fitxers ‚Äúocults‚Äù, ...)

---

## Eines

- Hi ha una llista completa a [http://sectools.org/](http://sectools.org/)
- Els pen testers utilitzen eines per
  - **Sondejar** un objectiu
  - **Recollir informaci√≥** i **provar** hip√≤tesis al respecte
  - **Explotar** una vulnerabilitat (o intentar-ho)
- Quina eina utilitzar dep√®n de l'objectiu
  - Si es tracta d'una **xarxa empresarial**, volem trobar, investigar i explotar m√†quines, encaminadors, topologia, etc.
  - Si es tracta d'**una √∫nica m√†quina**, volem tenir en compte programari instal¬∑lat, programes en execuci√≥, fitxers interessants
  - Si es tracta d'**un sol programa**, volem explorar i explotar possibles entrades i interaccions

---

## _nmap_ per al sondeig de la xarxa

- `nmap` significa "mapejador de xarxa"
- Per descobrir:
  - quins **hosts** estan disponibles a la xarxa,
  - quins **serveis** (nom i versi√≥ de l'aplicaci√≥) ofereixen aquests hosts,
  - quins **sistemes operatius** (i versions del sistema operatiu) estan executant,
  - quin tipus de **filtres de paquets/tallafocs** s'utilitzen
  - ... i m√©s
- Funciona enviant **paquets IP raw** (en brut) a la xarxa i **observant-ne els efectes**
- Gratu√Øt, codi obert: [http://nmap.org](http://nmap.org)

---

## Trobar hosts i serveis

- `nmap` far√† **ping** a un **interval d'adreces IP** especificat
  - Sol¬∑licitud d'**echo ICMP** i/o sol¬∑licitud de **timestamp**
    - Protocol est√†ndard ‚Äúping‚Äù.
  - **TCP SYN** al port 443, **TCP SYN/ACK** al port 80
    - Cercant executar servidors HTTPS o HTTP
  - Altres coses, segons determini l'operador
    - Paquets UDP espec√≠fics del protocol a ports concrets
    - Proves a altres ports TCP
    - Proves que provoquen respostes diferents en diferents sistemes operatius ("empremtes digitals")
- Sigues sigil√≥s
  - Es pot detectar una r√†fega d'activitat d'escaneig
  - Controla la velocitat d'escaneig per "treballar sota el radar"

---

## Zap (Zed Attack Proxy)

![Zap](./img/zap.png)

- **ZAP** √©s una eina de **seguretat web** desenvolupada per OWASP
- Permet **inspeccionar i modificar paquets** capturats mitjan√ßant una interf√≠cie gr√†fica (GUI).
- Suporta **punts d'interrupci√≥** (_breakpoints_) per controlar el flux dels paquets.

---v

- **Funcionalitats principals**:
  - **Escaneig actiu**: detecta vulnerabilitats com XSS i injecci√≥ SQL.
  - **Fuzzing**: proves amb c√†rregues √∫tils adaptades al context.
  - **Spider**: explora i mapeja l'estructura d'un lloc web.

---

## Metasploit

![Metasploit](./img/metasploit.png)

- **Metasploit** √©s una plataforma de codi obert per **desenvolupar, provar i executar exploits**.
- Inclou un model modular per combinar **exploits** i **payloads**.
  - **Exploit**: √©s un codi o t√®cnica que aprofita una vulnerabilitat en un sistema (software o servei) per executar accions no desitjades
  - **Payloads**: codi que s'executa un cop l'exploit ha tingut √®xit

---v

- Proc√©s t√≠pic:
  1. Sondejar objectiu cercant serveis vulnerables
  2. Triar un exploit
  3. Triar un payload
  4. Codificar el payload per evitar detecci√≥
  5. Executar (`exploit`) i obtenir shell remot

---v

![Metasploit](./img/metasploit-2.png)

---v

![Metasploit](./img/metasploit-3.png)

---v

## Capacitats de Metasploit

- Centenars de m√≤duls:
  - **Exploits** per vulnerabilitats conegudes
  - **Sniffing** de contrasenyes
  - **Escalada de privilegis**
  - **Keylogging** i **backdoors**
- Suporta atacs **actius i passius**
- M√©s info: [Metasploit Unleashed](https://www.offsec.com/metasploit-unleashed/)

---

## Como Usar METASPLOIT Framework en Kali Linux

<!-- markdownlint-disable MD033 -->
<iframe width="560" height="315" src="https://www.youtube.com/embed/sgA8ru5OIU4?si=1p9MxM88V4npLJol" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
<!-- markdownlint-enable MD033 -->

---

## Kali Linux

![Kali Linux](./img/kali-linux.png)

- Kali √©s una **distribuci√≥ de Linux** amb moltes eines de **pen testing** de codi obert **instal¬∑lades i configurades**

---v

- Els que ja hem esmentat:
  - `nmap`, Zap, Metasploit, Burp Suite
- i desenes m√©s
  - **John the Ripper** per descobriment de contrasenyes
  - **Valgrind** per a l'an√†lisi bin√†ria din√†mica
  - **Reaver** per trencar contrasenyes Wifi
  - **peepdf** per escanejar fitxers PDF per cercar vectors d'atac
  - ... i m√©s
- [http://www.kali.org](http://www.kali.org)

---

## Kali Linux Tutorial For Beginners

<!-- markdownlint-disable MD033 -->
<iframe width="560" height="315" src="https://www.youtube.com/embed/WUMo7LMRdwA?si=v54iw7jARPD9frpX" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
<!-- markdownlint-enable MD033 -->

---

## Enginyeria inversa

> Reverse engineering

---

## Reverse engineering (Enginyeria inversa)

- Consisteix a **desmuntar un programa executable** per entendre com funciona.
- En programari, implica convertir el **codi m√†quina** en una forma llegible (codi font o quasi font).
- **Objectius principals**:
  - Analitzar el funcionament intern del programa
  - Crear programari compatible o millorat
  - Detectar funcionalitats ocultes (com portes del darrere)
  - Identificar **vulnerabilitats** o decisions de disseny insegures

---v

- Entre les **eines** m√©s habituals per a l'enginyeria inversa existeixen:
  - descompiladors (_decompilers_)
  - depuradors (_debuggers_)
  - desassembladors (_disassemblers_)
  - framewoks, etc.

---v

- L'an√†lisi inclou:
  - Rastreig del flux d'execuci√≥ i crides a funcions
  - Infer√®ncia de tipus de dades i estructura de la pila
  - Observaci√≥ de valors en registres i flags
- **Eines populars**: com _IDA Pro_ (desassemblador i depurador)
- **Riscs potencials**:
  - Modificaci√≥ no autoritzada del codi
  - Fuites de codi confidencial si no es protegeix adequadament

---

## Llenguatge d'Assemblador

- El **llenguatge d'assemblador** √©s un llenguatge de **baix nivell** molt proper al **codi m√†quina**, comprensible pels humans.
  - Es basa en instruccions que corresponen gaireb√© directament a les operacions del **microprocessador**.
  - Exemple: `mov rax, 1` o `cmp rax, rbx`

---v

### ü¶Ä Rust ‚Üí Compilaci√≥ a codi m√†quina

- **Rust no s'interpreta**: es **compila** directament a **codi m√†quina** mitjan√ßant el compilador `rustc`.
- Durant la compilaci√≥:
  1. El codi Rust es transforma internament a LLVM IR (Intermediate Representation)
  2. LLVM optimitza i genera el **codi d'assemblador**
  3. L'assemblador es converteix finalment en binari executable

---v

### üõ†Ô∏è An√†lisi i enginyeria inversa

- Es pot **desassemblar** un binari compilat en Rust o C/C++ per obtenir **codi d'assemblador**.
- Tot i la seguretat i abstractions de Rust, **els binaris resultants es poden analitzar** com qualsevol altre executable en C/C++.
- Eines com `objdump`, `GDB`, `IDA Pro`, `radare2` o `Ghidra` permeten veure i depurar el resultat final en llenguatge d'assemblador.

---

## Desassembladors (_Dissassemblers_)

- Un **desassemblador** converteix **codi m√†quina** en **llenguatge d'assemblador** per analitzar el funcionament intern d'un executable.
- En programes Rust (compilats a codi nadiu), permet **examinar el resultat del proc√©s de compilaci√≥**.
- **Eines habituals**:
  - `objdump` ‚Äì eina cl√†ssica per veure el codi assemblador (`objdump -d target/debug/nom`)
  - `radare2`, `IDA Pro`, `Ghidra` ‚Äì entorns m√©s potents per an√†lisi i enginyeria inversa
  - Alguns **depuradors** com `GDB` tamb√© mostren desassemblat

> üìå √ötil per estudiar el codi generat per Rust i optimitzacions aplicades.

---

## Descompiladors (_decompilers_)

- Un **descompilador** √©s una eina que intenta recuperar **codi font llegible** a partir d'un executable compilat.
- En el cas de **Rust**, la descompilaci√≥ √©s **especialment dif√≠cil** perqu√®:
  - El codi es compila a **LLVM IR**, i despr√©s a **codi m√†quina** molt optimitzat.
  - L'**optimitzaci√≥** i l'√∫s intensiu de **tipus avan√ßats** complica la recuperaci√≥ del codi original.

---v

### üîç Qu√® pots obtenir, a partir d'un binari Rust?

- Amb eines com **Ghidra**, **IDA Pro** o **Radare2** pots:
  - Visualitzar el **codi d'assemblador** resultant
  - Fer an√†lisi del **flux de control** i dels **tipus de dades**
- Per√≤ **no** √©s possible recuperar el codi Rust tal com estava escrit originalment.
  - El millor que pots obtenir √©s una **representaci√≥ aproximada en C** o pseudo-codi.

---v

### Exemples de descompiladors per a C/C++

- **Boomerang**
  - Disponible per a Windows i Linux
  - Intenta generar codi en C, per√≤ sovint mostra parts en **assemblador** quan no pot reconstruir b√© l'estructura
  - [https://boomerang.sourceforge.net/](https://boomerang.sourceforge.net/)
- **REC Studio**
  - Pot descompilar executables de **Windows, Linux i macOS** (32 i 64 bits)
  - Genera una **representaci√≥ llegible en C** a partir del binari
  - [http://www.backerstreet.com/rec/recdload.htm](http://www.backerstreet.com/rec/recdload.htm)

![Boomarang](./img/boomerang.png)

---

## Depuradors (_Debuggers_)

- Un **depurador** permet **executar pas a pas** un programa, **inspeccionar variables**, la mem√≤ria i trobar errors.
- En Rust, es poden usar depuradors de baix nivell perqu√® el codi es compila a binaris nadius.
- **Eines habituals**:
  - **GDB** (GNU Debugger) ‚Äì molt usat a Linux
    [https://www.sourceware.org/gdb/](https://www.sourceware.org/gdb/)
  - **LLDB** ‚Äì depurador de LLVM, compatible amb Rust (`rust-lldb`)
  - **VS Code** + extensi√≥ **CodeLLDB** ‚Äì entorn gr√†fic molt pr√†ctic

> ‚úÖ Compila amb `cargo build` (mode debug) per permetre la depuraci√≥.

---v

## GDB

- **GDB** (GNU Debugger) √©s una eina de l√≠nia d'ordres per **depurar programes nadius**, permetent executar-los pas a pas i inspeccionar-ne l'estat intern (variables, pila, registres...)

![GDB](./img/gdb.png)

---

## IDA Pro: eina d'an√†lisi de binaris

- **IDA Pro** (Interactive DisAssembler) √©s una eina **comercial** molt potent per a **enginyeria inversa i desassemblatge**.
- Compatible amb **Windows, Linux i macOS**, admet **m√∫ltiples arquitectures**.
- Funcionalitats principals:
  - **Desassemblador interactiu**
  - **Depuraci√≥** de binaris (local i remota)
  - Vista gr√†fica del **flux de control**
  - Suport per a **plugins i scripting en Python**

> Molt utilitzada en **recerca de vulnerabilitats**, **an√†lisi de malware** i **auditories de seguretat**.

üîó [https://hex-rays.com](https://hex-rays.com)

---v

![IDA Pro](./img/ida-pro.png)

---

## Radare2: eina d'enginyeria inversa

![Radare](./img/radare.png)

- **Radare2** √©s un framework de codi obert per a **enginyeria inversa i an√†lisi de binaris**.
- Compatible amb **Linux, Windows, macOS, Android, iOS** i m√©s (incl√≤s a Kali Linux).
- Funcionalitats:
  - **Desassemblador i depurador** per a m√∫ltiples arquitectures
  - **An√†lisi de codi i forense**
  - Suport per **scripts (Python, etc.)** i treball col¬∑laboratiu
- M√©s info: [radare.org](https://www.radare.org/)

---

## Tot el necessari sobre Radare2

<!-- markdownlint-disable MD033 -->
<iframe width="560" height="315" src="https://www.youtube.com/embed/UGlYvPlIJKs?si=mQPqCQ5UgGRV5hrx" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
<!-- markdownlint-enable MD033 -->

---

## Ghidra: eina d'enginyeria inversa

- **Ghidra** √©s una eina de codi obert per a **enginyeria inversa**, desenvolupada per la **NSA** (Ag√®ncia de Seguretat Nacional).
- Compatible amb **Windows, Linux i macOS** (32 i 64 bits).
- Permet **desassemblar, descompilar i analitzar binaris** amb una interf√≠cie gr√†fica avan√ßada.
- Es pot **extendre amb plugins** escrits en **Java o Python**.
  - Ex.: `dex2jar` per analitzar aplicacions Android.

üîó [https://ghidra-sre.org](https://ghidra-sre.org)

---

## Enginyeria inversa utilitzant Ghidra

<!-- markdownlint-disable MD033 -->
<iframe width="560" height="315" src="https://www.youtube.com/embed/aQICC0EtG90?si=JxJFkZiMiW2a1-2_" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
<!-- markdownlint-enable MD033 -->

---

## Ghidra for Reverse Engineering

<!-- markdownlint-disable MD033 -->
<iframe width="560" height="315" src="https://www.youtube.com/embed/oTD_ki86c9I?si=R2_dqoHprWzvTgWt" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
<!-- markdownlint-enable MD033 -->

---

## Fuzzing

> Un tipus de random testing

---

<!-- markdownlint-disable MD024 -->

## Fuzzing

<!-- markdownlint-enable MD024 -->

- El **fuzzing** √©s una t√®cnica automatitzada de **proves aleat√≤ries** per detectar errors o vulnerabilitats.
- Consisteix a injectar **dades malformades o inesperades** per provar la robustesa del codi.

---

## T√®cniques de fuzzing

- **Black-box**: no coneix el programa ni l'entrada. F√†cil d'aplicar per√≤ poc profund.
- **White-box**: utilitza informaci√≥ del codi (ex: cobertura de l√≠nies) per generar les entrades. M√©s eficient, per√≤ m√©s cost√≥s.
- **Basat en gram√†tica**: genera entrades v√†lides seguint estructures conegudes.

---

## Estrat√®gies d'entrada al fuzzing

- **Mutaci√≥**: canvis aleatoris sobre entrades conegudes
- **Generacional**: creaci√≥ d'entrades des de zero, per exemple, a partir de gram√†tiques
- **Combinat**: barreja dels dos enfocaments

> üìå Despr√©s d'un **crash**, cal analitzar si √©s **reprodu√Øble**, **simplificable** i si representa una **vulnerabilitat real**.

---

## Learn How to Fuzz Your Rust Code in 10 Minutes

<!-- markdownlint-disable MD033 -->
<iframe width="560" height="315" src="https://www.youtube.com/embed/ePD_ojZxI0c?si=fGJh4_4Gbt059ihJ" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
<!-- markdownlint-enable MD033 -->

---

## Resum

- Els pen testers simulen atacants reals
  - Intenten trobar vulnerabilitats explotables en sistemes complets
- Les penetracions indiquen **problemes reals**
  - La manca de penetracions **no √©s prova d'impossibilitat**
- Els pen testers utilitzen una **varietat d'eines**
  - Esc√†ners, proxies, injectors d'exploits, fuzzers
- I requereixen **enginy** i **astucia**

---

## Hacking √®tic

- Les eines de pen testing estan destinades a **revelar vulnerabilitats de seguretat**
  - **Perqu√® es puguin arreglar**
  - No perqu√® es puguin explotar
- **Per√≤** hi ha gent que utilitza eines amb **finalitats nefastes**
  - **No siguis un d'ells!**

![Dark side](./img/dark-side.png)
